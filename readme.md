# da4ml results reproduction instructions

This repository contains code and instructions to reproduce the major results reported in the [da4ml paper](https://dl.acm.org/doi/10.1145/3777387).


## Requirements

- `python>=3.10` (`3.11+` recommended)
- `gnu make` and `g++` for building
- Reasonably modern linux system (e.g., OpenSUSE Leap 16) with reasonable amount of RAM (At least 32GB+)
- `Vivado 2023.2` with license for synthesis and implementation for `xcvu13p-flga2577-2-e`
- Optional, but strongly recommended: `gnu_parallel` for parallel execution

For python dependencies, run:

```bash
pip install --pre -r requirements.txt
```

## Instruction for each result

### Microbenchmarks

#### Table 2

Run `table2.ipynb`, and the results will be generated at cell 15.

#### Table 3, 4

```bash
export WORKING_DIR_RANDMAT=/tmp/da4ml-ae/rand_mat # example path, edit as needed
export N_PROC=1 # Number of parallel instances for synthesis, set according to your system capabilities

# Convert the random matrices, enforcing a latency of one clock cycle for measuring combinational delay
./convert_rand_mat.sh $WORKING_DIR_RANDMAT

# Run HLS synthesis. If you do not have gnu_parallel installed, you can run the commands one by one inside each directory.
ls $WORKING_DIR_RANDMAT/* | parallel --bar -j $N_PROC 'cd {} && singularity exec /data/containers/vivado-2023.2.sif vitis-run --mode hls --tcl build_prj.tcl > synth.log'

# Print reports for tables 3 and 4
python report_hls.py $WORKING_DIR_RANDMAT/*bw=8* -s N dc -c dc N LUT DSP FF 'Latency [ns]'
python report_hls.py $WORKING_DIR_RANDMAT/*bw=4* -s N dc -c dc N LUT DSP FF 'Latency [ns]'
```

### Realistic Networks

#### Table 5, 6, 10, 11

```bash
# example path, edit as needed
export WORKING_DIR_JSC_OPENML=/tmp/da4ml-ae/jsc_open

# Convert with targets of 200MHz and 1GHz
./convert.sh jsc/openml $WORKING_DIR_JSC_OPENML 5
./convert.sh jsc/openml $WORKING_DIR_JSC_OPENML 1

# Run HLS synthesis 
ls -d $WORKING_DIR_JSC_OPENML/*/* | parallel --bar -j $N_PROC 'cd {} && singularity exec /data/containers/vivado-2023.2.sif vitis-run --mode hls --tcl build_prj.tcl > synth.log'

# Print reports for tables 5 and 6
python report_hls.py $WORKING_DIR_JSC_OPENML/period=5/* -s _test_acc -c use_da test_acc Latency 'Latency [ns]' LUT DSP FF 'Fmax [MHz]'
python report_hls.py $WORKING_DIR_JSC_OPENML/period=1/* -s _test_acc -c use_da test_acc Latency 'Latency [ns]' LUT DSP FF 'Fmax [MHz]'
```

For the RTL results in tables 10 and 11, run in addition:

```bash
# Run Vivado OOC P&R
ls -d $WORKING_DIR_JSC_OPENML/rtl-period=*/* | parallel --bar -j $N_PROC 'cd {} && > vivado -mode batch -source build_vivado_prj.tcl > synth.log'

# Print reports for RTL models in tables 10 and 11
da4ml report $WORKING_DIR_JSC_OPENML/rtl-period=5/* -c test_acc latency 'latency(ns)' LUT DSP FF 'Fmax(MHz)'
da4ml report $WORKING_DIR_JSC_OPENML/rtl-period=1/* -c test_acc latency 'latency(ns)' LUT DSP FF 'Fmax(MHz)'
```


#### Table 9, 12

> WARNING: this synthesis may be very slow and require a large amount of RAM (~100GB). Skip this part if not strongly needed. The same model's RTL version (table 12) is much less demanding.

```bash
# example path, edit as needed
export WORKING_DIR_MLPM=/tmp/da4ml-ae/mlp-mixer

# Convert with target frequency of 200MHz
./convert.sh mlp-mixer $WORKING_DIR_MLPM 5

# Run HLS synthesis for table 9
ls -d $WORKING_DIR_MLPM/* | parallel --bar -j $N_PROC 'cd {} && singularity exec /data/containers/vivado-2023.2.sif vitis-run --mode hls --tcl build_prj.tcl > synth.log'

# Print reports for table 9
python report_hls.py $WORKING_DIR_MLPM/period=5/* -s _test_acc -c use_da test_acc Latency 'Latency [ns]' LUT DSP FF 'Fmax [MHz]'
```

For the RTL results in table 12, run in addition:

```bash
# Run Vivado OOC P&R
ls -d $WORKING_DIR_MLPM/rtl-period=5/* | parallel --bar -j $N_PROC 'cd {} && > vivado -mode batch -source build_vivado_prj.tcl > synth.log'

# Print reports for RTL models in table 12
da4ml report $WORKING_DIR_MLPM/rtl-period=5/* -c test_acc latency 'latency(ns)' LUT DSP FF 'Fmax(MHz)'
```

#### Table 13, High-level feature jet tagging network (CERN Box)

```bash
# example path, edit as needed
export WORKING_DIR_CERNBOX=/tmp/da4ml-ae/cernbox

# Convert with target frequency of 1GHz
./convert.sh cernbox $WORKING_DIR_CERNBOX 1

# Run Vivado OOC P&R
ls -d $WORKING_DIR_CERNBOX/rtl-period=1/* | parallel --bar -j $N_PROC 'cd {} && > vivado -mode batch -source build_vivado_prj.tcl > synth.log'

# Print reports for RTL models in table 13
da4ml report $WORKING_DIR_CERNBOX/rtl-period=1/* -c test_acc latency 'latency(ns)' LUT DSP FF 'Fmax(MHz)'
```

## Notes

- The provided scripts and commands assume a certain directory structure and naming conventions as generated by the `da4ml` conversion scripts. Adjust paths as necessary.
- You may use a different machine to run the synthesis and implementation steps if needed. The projects generated by da4ml or hls4ml are portable. 